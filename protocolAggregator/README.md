# protocolaggregator Cordap

This Cordapp is the complete implementation of data aggregation protocol with conclave(enclave) environment.

## Concepts

Multiple Nodes within the corda network will be able to exchange encrypted-data with cryptography according to roles like `provider` & `consumer`.


### Flows

#### CoalitionConfigurationUpdateFlow
Through this flow network manager/host can configure data type being used for Data Aggregation. All data type is an avro schema definition & associated with its data type code.
This flow will generate CoalitionConfigurationState to be utilized by other nodes.

#### ConsumerAggregationFlow
This flow is kicked off by any node in network with assigned role as consumer. Consumer can utilize it for start data aggregation process
& according to configuration state defined by hosts, all other nodes can participate in it with their relevant role.
It will generate DataOutputState between consumer & host node.

#### ConsumerAggregationResponseFlow
This flow will originate in response to ConsumerAggregationFLow & handles communication session between consumer node and host node.
One more thing it is responsible is it will initiate flows between host and providers.

#### ProviderAggregationResponseFlow
This flow will behave as responder flow to ConsumerAggregationFLow. ProviderAggregationResponderFlow could only be initiated by ConsumerAggregationResponse flow.
ProviderAggregationResponseFlow will create Rewards states between host & provider.

#### ConsumerDataOutputRetrievalFlow
To retrieve output data generated by consumer aggregation, this flow will be utilized by node. Functionality of this flow consists querying existing consumer node's vault
to retrieve output Data stored during aggregation.

#### ProviderRewardOutputRetrievalFlow
To retrieve reward output data generated by aggregation enclave for that particular provider input.  Functionality of this flow consists querying existing provider node's vault
to retrieve reward output assigned by aggregation enclave after data aggregation cycle.

### Contract States

#### CoalitionConfigurationState

This state will be generated in given corda network by host with below properties. It will be generated in response of `CoalitionConfigurationUpdateFlow` flow executed by host fo network.
1) DataTypeCode - unique code for the schema
2) DataTypeDisplay - display name for the schema druing aggregation cycle
3) SchemaFile - original avro schema file to be used by all nodes in data aggregation

CoalitionConfigurationState will be shared between all participant node in network.

#### DataOutputState

This State will be generated in response of `ConsumerAggregationFlow` flow between consumer node & host node. So that it'll be shared between consumer & host.

It'll have information like host details, consumer details, data output, creation date and flow topic created during aggregation cycle.

#### RewardsState

During `ProviderAggregationResponseFlow` flow, this state will be generated. It'll be shared between provider and host.

It'll have information like host details, provider details, date created, rewards data and flow topic during aggregation cycle.

### Enclave

#### AggregationEnclave
This enclave interface will be utilized to create extended version of enclave for Data Aggregation. Developer need to implement some of abstract method provided
into this interface to make data aggregation & reward calculation according to their business requirement & Use case specific.

Mandatory implementation needs to be provided for `createAggregateDataOutput` & `createRewardsDataOutput` in the aggregation specific version of enclave.

This both functions could use available existing aggregation enclave features from the interface(AggregationEnclave) to support implementation.

As an example, to know which schema is being utilized by current aggregation cycle, `envelopeSchema` data member from the AggregationEnclave interface will be used.

### Avro

Role of Avro in this Aggregation is for serialization-deserialization of given data sets. Data will always be provided & retrieved in the form of avro serialization with schema type
decided by coalition configuration initially. Data sets will be strictly bounded by schema type configured in coalition configuration by host node.

#### Avro Schema

Specific format will always be required for aggregation, so that enclave can perform data aggregation effectively.
Few must have elements are like `aggregateInput`, `aggregateOutput` and `rewardsOutput`. On bases of these elements enclave can perform data aggregation.
Developers are free to have their own version of embedded records inside above elements. And use those structure while their Aggregation Enclave specific implementation.

## Usage

### Running the CorDapp

Build ProtocolAggregator.

Once your application passes all tests in `AggregatorEnlcaveTest` inside workflows, you can run the application and
interact with it via a web browser or command line terminal. To run the finished application, you have two choices for each language: from the terminal, and from IntelliJ.

Open a terminal and go to the project root directory and type: (to deploy the nodes using bootstrapper)
```
./gradlew clean deployNodes
```
Then type: (to run the nodes)
```
./build/nodes/runnodes
```

### Starting the webserver
Once the nodes are up, we will start the webservers next. This app consists of three nodes and one notary, so we will be starting 3 webservers separately. First, lets start PartyA's webserver. Open a new tab of the terminal (make sure you are still in the project directory) and run:
```
./gradlew runPartyAServer
```
repeat the same for PartyB and PartyC, run each of the commands in a new tab:
```
./gradlew runPartyBServer
```
and
```
./gradlew runPartyCServer
```
